<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chorly - Family Chore Management</title>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #f1f5f9;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --text: #1e293b;
            --text-light: #64748b;
            --border: #e2e8f0;
            --bg: #ffffff;
            --bg-secondary: #f8fafc;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--text);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .title {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            text-align: center;
            margin-bottom: 10px;
        }

        .subtitle {
            text-align: center;
            color: var(--text-light);
            font-size: 1.1rem;
        }

        .auth-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 40px;
            max-width: 400px;
            margin: 50px auto;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .dashboard {
            display: grid;
            gap: 20px;
        }

        .admin-controls {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .family-members {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .member-box {
            background: white;
            border-radius: 15px;
            padding: 15px;
            text-align: center;
            min-width: 120px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border: 3px solid transparent;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
        }

        .member-box:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
        }

        .member-box.selected {
            border-color: var(--primary);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .member-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            margin: 0 auto 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            color: white;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .member-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .member-streak {
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .selected .member-streak {
            color: rgba(255, 255, 255, 0.8);
        }

        .view-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .toggle-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 25px;
            background: rgba(255, 255, 255, 0.7);
            color: var(--text);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .toggle-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .tasks-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .task-item {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border-left: 5px solid var(--primary);
            transition: all 0.3s ease;
            position: relative;
        }

        .task-item:hover {
            transform: translateX(5px);
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.15);
        }

        .task-item.completed {
            opacity: 0.7;
            border-left-color: var(--success);
        }

        .task-item.overdue {
            border-left-color: var(--danger);
            background: linear-gradient(90deg, #fef2f2 0%, white 20%);
        }

        .task-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .task-title {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--text);
        }

        .task-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .task-time {
            background: var(--secondary);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            color: var(--text-light);
            font-weight: 500;
        }

        .task-description {
            color: var(--text-light);
            margin-bottom: 15px;
            line-height: 1.5;
        }

        .task-assignee {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .assignee-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.8rem;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: var(--secondary);
            color: var(--text);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .btn-icon {
            background: none;
            border: none;
            padding: 8px;
            border-radius: 50%;
            cursor: pointer;
            color: var(--text-light);
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
        }

        .btn-icon:hover {
            background: var(--secondary);
            color: var(--text);
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light);
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }

        .close-btn:hover {
            background: var(--secondary);
            color: var(--text);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text);
        }

        .input, .textarea, .select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        .input:focus, .textarea:focus, .select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .textarea {
            resize: vertical;
            min-height: 100px;
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .checkbox-item:hover {
            background: var(--secondary);
        }

        .checkbox-item input[type="checkbox"] {
            margin: 0;
        }

        .recurring-options {
            margin-top: 15px;
            padding: 15px;
            background: var(--bg-secondary);
            border-radius: 12px;
            border: 2px solid var(--border);
            display: none;
        }

        .recurring-options.show {
            display: block;
        }

        .form-row {
            display: flex;
            gap: 15px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .btn-group {
            display: flex;
            gap: 12px;
            margin-top: 30px;
        }

        .btn-group .btn {
            flex: 1;
        }

        .admin-nav {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border);
        }

        .nav-btn {
            padding: 10px 20px;
            border: none;
            background: none;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            font-weight: 600;
            color: var(--text-light);
            transition: all 0.3s ease;
        }

        .nav-btn.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .admin-content {
            min-height: 300px;
        }

        .people-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }

        .person-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            border: 2px solid var(--border);
            transition: all 0.3s ease;
        }

        .person-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
        }

        .person-avatar-large {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            font-weight: bold;
            color: white;
        }

        .person-name {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--text);
        }

        .color-picker {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            margin: 15px 0;
        }

        .color-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .color-option:hover {
            transform: scale(1.1);
        }

        .color-option.selected {
            border-color: white;
            box-shadow: 0 0 0 2px var(--text);
        }

        .tasks-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .family-members {
                justify-content: center;
            }

            .member-box {
                min-width: 100px;
            }

            .form-row {
                flex-direction: column;
            }

            .btn-group {
                flex-direction: column;
            }
        }

        .hidden {
            display: none !important;
        }

        .loading {
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .loading::after {
            content: '';
            width: 16px;
            height: 16px;
            border: 2px solid currentColor;
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">Chorly</h1>
            <p class="subtitle">Making family chores fun and organized</p>
        </div>

        <div id="app">
            <!-- Content will be dynamically loaded here -->
        </div>
    </div>

    <script>
        // Application state
        let appState = {
            isAuthenticated: false,
            user: null,
            selectedPerson: null,
            currentView: 'today',
            adminView: 'people',
            people: [],
            tasks: []
        };

        // Color options for family members
        const colorOptions = [
            '#667eea', '#764ba2', '#f093fb', '#f5576c',
            '#4facfe', '#00f2fe', '#43e97b', '#38f9d7',
            '#ffecd2', '#fcb69f', '#a8edea', '#fed6e3',
            '#ff9a9e', '#fecfef', '#ffeaa7', '#fab1a0',
            '#fd79a8', '#fdcb6e', '#e17055', '#74b9ff',
            '#0984e3', '#6c5ce7', '#a29bfe', '#fd79a8'
        ];

        // API helper function
        async function apiRequest(url, options = {}) {
            try {
                const response = await fetch(url, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });

                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(`${response.status}: ${error}`);
                }

                return await response.json();
            } catch (error) {
                console.error('API request failed:', error);
                throw error;
            }
        }

        // Authentication functions
        async function login(email, password) {
            try {
                const result = await apiRequest('/api/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({ email, password })
                });
                return result;
            } catch (error) {
                console.error('Login failed:', error);
                return { success: false, error: error.message };
            }
        }

        async function verifyAdminPin(pin, personId) {
            try {
                const result = await apiRequest('/api/auth/verify-admin-pin', {
                    method: 'POST',
                    body: JSON.stringify({ pin, personId })
                });
                return result;
            } catch (error) {
                console.error('PIN verification failed:', error);
                return { success: false, error: error.message };
            }
        }

        // Person management functions
        async function savePerson(personData) {
            try {
                console.log('Saving person:', personData);
                
                // Simulate API call delay
                await new Promise(resolve => setTimeout(resolve, 300));
                
                // Update local state
                const personIndex = appState.people.findIndex(p => p.id === personData.id);
                if (personIndex !== -1) {
                    appState.people[personIndex] = { ...appState.people[personIndex], ...personData };
                    console.log('Person updated successfully');
                }
                
                // Persist to localStorage
                localStorage.setItem('familyMembers', JSON.stringify(appState.people));
                
                return { success: true };
            } catch (error) {
                console.error('Failed to save person:', error);
                return { success: false, error: error.message };
            }
        }

        // Task management functions
        async function saveTask(taskData) {
            try {
                console.log('Saving task:', taskData);
                
                // Simulate API call delay
                await new Promise(resolve => setTimeout(resolve, 800));
                
                if (taskData.id) {
                    // Update existing task in local state
                    const taskIndex = appState.tasks.findIndex(t => t.task?.id === taskData.id);
                    if (taskIndex !== -1) {
                        appState.tasks[taskIndex].task = { 
                            ...appState.tasks[taskIndex].task, 
                            ...taskData 
                        };
                        
                        // Update other properties if they exist in taskData
                        if (taskData.assignedTo?.length > 0) {
                            appState.tasks[taskIndex].assignedTo = taskData.assignedTo[0];
                        }
                        if (taskData.dueDate) {
                            appState.tasks[taskIndex].dueDate = taskData.dueDate;
                        }
                    }
                    console.log('Task updated successfully');
                } else {
                    // Create new task in local state
                    const newTaskId = Date.now();
                    const newTask = {
                        id: newTaskId,
                        task: {
                            id: newTaskId,
                            ...taskData
                        },
                        assignedTo: taskData.assignedTo?.[0] || appState.people[0]?.id || 1,
                        dueDate: taskData.dueDate,
                        isCompleted: false,
                        isOverdue: false
                    };
                    appState.tasks.push(newTask);
                    console.log('Task created successfully');
                }
                
                // Persist to localStorage
                localStorage.setItem('familyTasks', JSON.stringify(appState.tasks));
                
                return { success: true };
            } catch (error) {
                console.error('Failed to save task:', error);
                return { success: false, error: error.message };
            }
        }

        async function completeTask(taskInstanceId) {
            try {
                const taskIndex = appState.tasks.findIndex(t => t.id === taskInstanceId);
                if (taskIndex !== -1) {
                    appState.tasks[taskIndex].isCompleted = true;
                    
                    // Award points
                    const assignedPersonId = appState.tasks[taskIndex].assignedTo;
                    const personIndex = appState.people.findIndex(p => p.id === assignedPersonId);
                    if (personIndex !== -1) {
                        appState.people[personIndex].totalPoints += 10;
                        appState.people[personIndex].currentStreak += 1;
                    }
                    
                    // Persist changes
                    localStorage.setItem('familyTasks', JSON.stringify(appState.tasks));
                    localStorage.setItem('familyMembers', JSON.stringify(appState.people));
                }
                
                return { success: true };
            } catch (error) {
                console.error('Failed to complete task:', error);
                return { success: false, error: error.message };
            }
        }

        // Data loading functions
        async function loadDashboard() {
            try {
                // Load from localStorage first
                const savedMembers = localStorage.getItem('familyMembers');
                const savedTasks = localStorage.getItem('familyTasks');
                
                if (savedMembers) {
                    appState.people = JSON.parse(savedMembers);
                }
                
                if (savedTasks) {
                    appState.tasks = JSON.parse(savedTasks);
                }
                
                // If no saved data, try to load from API
                if (!savedMembers || !savedTasks) {
                    const result = await apiRequest('/api/dashboard');
                    if (result.success) {
                        appState.people = result.people || [];
                        appState.tasks = result.tasks || [];
                        
                        // Save to localStorage for persistence
                        localStorage.setItem('familyMembers', JSON.stringify(appState.people));
                        localStorage.setItem('familyTasks', JSON.stringify(appState.tasks));
                    }
                }
                
                // Set default selected person if none selected
                if (!appState.selectedPerson && appState.people.length > 0) {
                    appState.selectedPerson = appState.people[0].id;
                }
                
                return { success: true };
            } catch (error) {
                console.error('Failed to load dashboard:', error);
                
                // Use default data if API fails
                if (!appState.people.length) {
                    appState.people = [
                        { id: 1, nickname: 'Dad', avatar: '#667eea', currentStreak: 5, totalPoints: 120 },
                        { id: 2, nickname: 'Mum', avatar: '#f093fb', currentStreak: 3, totalPoints: 95 },
                        { id: 3, nickname: 'Seb', avatar: '#4facfe', currentStreak: 2, totalPoints: 60 },
                        { id: 4, nickname: 'Tessa', avatar: '#43e97b', currentStreak: 1, totalPoints: 40 }
                    ];
                }
                
                if (!appState.tasks.length) {
                    appState.tasks = [
                        {
                            id: 1,
                            task: { id: 1, title: 'Make bed', description: 'Tidy bedroom and make bed', estimatedMinutes: 10 },
                            assignedTo: 1,
                            dueDate: new Date().toISOString().split('T')[0],
                            isCompleted: false,
                            isOverdue: false
                        },
                        {
                            id: 2,
                            task: { id: 2, title: 'Feed pets', description: 'Feed dogs and cats', estimatedMinutes: 15 },
                            assignedTo: 2,
                            dueDate: new Date().toISOString().split('T')[0],
                            isCompleted: false,
                            isOverdue: false
                        }
                    ];
                }
                
                appState.selectedPerson = appState.people[0]?.id || 1;
                return { success: true };
            }
        }

        // Utility functions
        function createElement(tag, attrs = {}, children = []) {
            const el = document.createElement(tag);
            Object.entries(attrs).forEach(([key, value]) => {
                if (key === 'onClick') {
                    el.addEventListener('click', value);
                } else if (key === 'onChange') {
                    el.addEventListener('change', value);
                } else if (key === 'onInput') {
                    el.addEventListener('input', value);
                } else if (key === 'onSubmit') {
                    el.addEventListener('submit', value);
                } else if (key === 'className') {
                    el.className = value;
                } else if (key === 'style' && typeof value === 'object') {
                    Object.assign(el.style, value);
                } else {
                    el.setAttribute(key, value);
                }
            });
            
            children.forEach(child => {
                if (typeof child === 'string') {
                    el.appendChild(document.createTextNode(child));
                } else if (child) {
                    el.appendChild(child);
                }
            });
            
            return el;
        }

        function showModal(title, content) {
            const modal = createElement('div', { className: 'modal' }, [
                createElement('div', { className: 'modal-content' }, [
                    createElement('div', { className: 'modal-header' }, [
                        createElement('h2', { className: 'modal-title' }, [title]),
                        createElement('button', {
                            className: 'close-btn',
                            onClick: () => document.body.removeChild(modal)
                        }, ['×'])
                    ]),
                    content
                ])
            ]);

            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });

            document.body.appendChild(modal);
            return modal;
        }

        // Modal functions
        function showLoginModal() {
            const form = createElement('form', {
                onSubmit: async (e) => {
                    e.preventDefault();
                    const email = e.target.email.value;
                    const password = e.target.password.value;
                    const submitBtn = e.target.querySelector('button[type="submit"]');
                    const originalText = submitBtn.textContent;
                    
                    submitBtn.textContent = 'Logging in...';
                    submitBtn.disabled = true;
                    
                    const result = await login(email, password);
                    
                    if (result.success) {
                        appState.isAuthenticated = true;
                        appState.user = result.user;
                        document.body.removeChild(modal);
                        await loadDashboard();
                        renderDashboard();
                    } else {
                        alert(result.error || 'Login failed. Please try again.');
                        submitBtn.textContent = originalText;
                        submitBtn.disabled = false;
                    }
                }
            }, [
                createElement('div', { className: 'form-group' }, [
                    createElement('label', { className: 'label' }, ['Email']),
                    createElement('input', {
                        type: 'email',
                        name: 'email',
                        className: 'input',
                        defaultValue: 'family@example.com',
                        required: true
                    })
                ]),
                createElement('div', { className: 'form-group' }, [
                    createElement('label', { className: 'label' }, ['Password']),
                    createElement('input', {
                        type: 'password',
                        name: 'password',
                        className: 'input',
                        defaultValue: 'password123',
                        required: true
                    })
                ]),
                createElement('div', { className: 'btn-group' }, [
                    createElement('button', {
                        type: 'submit',
                        className: 'btn btn-primary'
                    }, ['Login'])
                ])
            ]);

            const modal = showModal('Login to Chorly', form);
            return modal;
        }

        function showAdminPinModal() {
            const form = createElement('form', {
                onSubmit: async (e) => {
                    e.preventDefault();
                    const pin = e.target.pin.value;
                    const submitBtn = e.target.querySelector('button[type="submit"]');
                    const originalText = submitBtn.textContent;
                    
                    submitBtn.textContent = 'Verifying...';
                    submitBtn.disabled = true;
                    
                    // For demo, accept PIN 1234
                    if (pin === '1234') {
                        document.body.removeChild(modal);
                        renderAdminPanel();
                    } else {
                        alert('Invalid PIN. Please try again.');
                        submitBtn.textContent = originalText;
                        submitBtn.disabled = false;
                        e.target.pin.value = '';
                        e.target.pin.focus();
                    }
                }
            }, [
                createElement('div', { className: 'form-group' }, [
                    createElement('label', { className: 'label' }, ['Enter Admin PIN']),
                    createElement('input', {
                        type: 'password',
                        name: 'pin',
                        className: 'input',
                        placeholder: 'Enter 4-digit PIN',
                        maxLength: 4,
                        required: true
                    })
                ]),
                createElement('div', { className: 'btn-group' }, [
                    createElement('button', {
                        type: 'button',
                        className: 'btn btn-secondary',
                        onClick: () => document.body.removeChild(modal)
                    }, ['Cancel']),
                    createElement('button', {
                        type: 'submit',
                        className: 'btn btn-primary'
                    }, ['Verify PIN'])
                ])
            ]);

            const modal = showModal('Admin Access Required', form);
            setTimeout(() => form.pin.focus(), 100);
            return modal;
        }

        function showEditTaskModal(task) {
            const isEditing = !!task?.id;
            const taskData = {
                id: task?.id || null,
                title: task?.title || '',
                description: task?.description || '',
                estimatedMinutes: task?.estimatedMinutes || 30,
                isRecurring: task?.isRecurring || false,
                recurringType: task?.recurringType || 'daily',
                recurringInterval: task?.recurringInterval || 1,
                recurringEndDate: task?.recurringEndDate || '',
                assignedTo: task?.assignedTo ? [task.assignedTo] : [],
                dueDate: task?.dueDate || new Date().toISOString().split('T')[0]
            };

            const form = createElement('form', {
                onSubmit: async (e) => {
                    e.preventDefault();
                    const submitBtn = e.target.querySelector('button[type="submit"]');
                    const originalText = submitBtn.textContent;
                    
                    // Capture form data directly from form elements
                    const formData = {
                        id: taskData.id,
                        title: e.target.title.value,
                        description: e.target.description.value,
                        estimatedMinutes: parseInt(e.target.estimatedMinutes.value),
                        dueDate: e.target.dueDate.value,
                        isRecurring: e.target.isRecurring?.checked || false,
                        assignedTo: Array.from(e.target.querySelectorAll('[name="assignedTo"]:checked')).map(cb => parseInt(cb.value))
                    };
                    
                    console.log('Form data captured:', formData);
                    
                    submitBtn.textContent = 'Saving...';
                    submitBtn.disabled = true;
                    
                    try {
                        const result = await saveTask(formData);
                        if (result.success) {
                            document.body.removeChild(modal);
                            await loadDashboard();
                            renderDashboard();
                        } else {
                            alert(result.error || 'Failed to save changes. Please try again.');
                        }
                    } catch (error) {
                        console.error('Failed to update task:', error);
                        alert('Network error. Please check your connection and try again.');
                    } finally {
                        submitBtn.textContent = originalText;
                        submitBtn.disabled = false;
                    }
                }
            }, [
                createElement('div', { className: 'form-group' }, [
                    createElement('label', { className: 'label' }, ['Task Title']),
                    createElement('input', {
                        type: 'text',
                        name: 'title',
                        className: 'input',
                        defaultValue: taskData.title,
                        placeholder: 'Enter task title',
                        required: true
                    })
                ]),
                createElement('div', { className: 'form-group' }, [
                    createElement('label', { className: 'label' }, ['Description']),
                    createElement('textarea', {
                        name: 'description',
                        className: 'textarea',
                        defaultValue: taskData.description,
                        placeholder: 'Enter task description'
                    })
                ]),
                createElement('div', { className: 'form-row' }, [
                    createElement('div', { className: 'form-group' }, [
                        createElement('label', { className: 'label' }, ['Minutes']),
                        createElement('input', {
                            type: 'number',
                            name: 'estimatedMinutes',
                            className: 'input',
                            defaultValue: taskData.estimatedMinutes,
                            min: 1
                        })
                    ]),
                    createElement('div', { className: 'form-group' }, [
                        createElement('label', { className: 'label' }, ['Due Date']),
                        createElement('input', {
                            type: 'date',
                            name: 'dueDate',
                            className: 'input',
                            defaultValue: taskData.dueDate
                        })
                    ])
                ]),
                createElement('div', { className: 'form-group' }, [
                    createElement('label', { className: 'label' }, ['Assigned To']),
                    createElement('div', { className: 'checkbox-group' },
                        appState.people.map(person => 
                            createElement('label', { className: 'checkbox-item' }, [
                                createElement('input', {
                                    type: 'checkbox',
                                    name: 'assignedTo',
                                    value: person.id,
                                    defaultChecked: taskData.assignedTo.includes(person.id)
                                }),
                                person.nickname
                            ])
                        )
                    )
                ]),
                createElement('div', { className: 'form-group' }, [
                    createElement('label', { className: 'checkbox-item' }, [
                        createElement('input', {
                            type: 'checkbox',
                            name: 'isRecurring',
                            defaultChecked: taskData.isRecurring
                        }),
                        'Recurring Task'
                    ])
                ]),
                createElement('div', { className: 'btn-group' }, [
                    createElement('button', {
                        type: 'button',
                        className: 'btn btn-secondary',
                        onClick: () => document.body.removeChild(modal)
                    }, ['Cancel']),
                    createElement('button', {
                        type: 'submit',
                        className: 'btn btn-primary'
                    }, [isEditing ? 'Save Changes' : 'Create Task'])
                ])
            ]);

            const modal = showModal(isEditing ? 'Edit Task' : 'Create Task', form);
            return modal;
        }

        function showEditPersonModal(person) {
            let selectedColor = person.avatar;
            let colorGrid;

            const updateColorSelection = (newColor) => {
                selectedColor = newColor;
                colorGrid.querySelectorAll('.color-option').forEach(opt => {
                    opt.classList.toggle('selected', opt.style.backgroundColor === newColor);
                });
            };

            const form = createElement('form', {
                onSubmit: async (e) => {
                    e.preventDefault();
                    const submitBtn = e.target.querySelector('button[type="submit"]');
                    const originalText = submitBtn.textContent;
                    
                    const personData = {
                        id: person.id,
                        nickname: e.target.nickname.value,
                        avatar: selectedColor
                    };
                    
                    submitBtn.textContent = 'Saving...';
                    submitBtn.disabled = true;
                    
                    try {
                        const result = await savePerson(personData);
                        if (result.success) {
                            document.body.removeChild(modal);
                            renderAdminPanel();
                        } else {
                            alert(result.error || 'Failed to save changes. Please try again.');
                        }
                    } catch (error) {
                        console.error('Failed to update person:', error);
                        alert('Failed to save changes. Please try again.');
                    } finally {
                        submitBtn.textContent = originalText;
                        submitBtn.disabled = false;
                    }
                }
            }, [
                createElement('div', { className: 'form-group' }, [
                    createElement('label', { className: 'label' }, ['Nickname']),
                    createElement('input', {
                        type: 'text',
                        name: 'nickname',
                        className: 'input',
                        defaultValue: person.nickname,
                        required: true
                    })
                ]),
                createElement('div', { className: 'form-group' }, [
                    createElement('label', { className: 'label' }, ['Avatar Color']),
                    colorGrid = createElement('div', { className: 'color-picker' },
                        colorOptions.map(color => 
                            createElement('div', {
                                className: `color-option ${color === selectedColor ? 'selected' : ''}`,
                                style: { backgroundColor: color },
                                onClick: () => updateColorSelection(color)
                            })
                        )
                    )
                ]),
                createElement('div', { className: 'btn-group' }, [
                    createElement('button', {
                        type: 'button',
                        className: 'btn btn-secondary',
                        onClick: () => document.body.removeChild(modal)
                    }, ['Cancel']),
                    createElement('button', {
                        type: 'submit',
                        className: 'btn btn-primary'
                    }, ['Save Changes'])
                ])
            ]);

            const modal = showModal('Edit Family Member', form);
            return modal;
        }

        // Render functions
        function renderLogin() {
            const container = document.getElementById('app');
            container.innerHTML = '';
            
            const authContainer = createElement('div', { className: 'auth-container' }, [
                createElement('h2', {}, ['Welcome to Chorly']),
                createElement('p', { style: { marginBottom: '20px', textAlign: 'center', color: 'var(--text-light)' } }, 
                    ['Sign in to manage your family chores']),
                createElement('button', {
                    className: 'btn btn-primary',
                    style: { width: '100%' },
                    onClick: showLoginModal
                }, ['Login'])
            ]);
            
            container.appendChild(authContainer);
        }

        function renderDashboard() {
            const container = document.getElementById('app');
            container.innerHTML = '';

            // Family members section
            const membersSection = createElement('div', { className: 'family-members' }, 
                appState.people.map(person => 
                    createElement('div', {
                        className: `member-box ${appState.selectedPerson === person.id ? 'selected' : ''}`,
                        onClick: () => {
                            appState.selectedPerson = person.id;
                            renderDashboard();
                        }
                    }, [
                        createElement('div', {
                            className: 'member-avatar',
                            style: { background: person.avatar }
                        }, [person.nickname.charAt(0)]),
                        createElement('div', { className: 'member-name' }, [person.nickname]),
                        createElement('div', { className: 'member-streak' }, [`${person.currentStreak} day streak`])
                    ])
                )
            );

            // Controls section
            const controlsSection = createElement('div', { className: 'admin-controls' }, [
                createElement('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' } }, [
                    createElement('div', { className: 'view-toggle' }, [
                        createElement('button', {
                            className: `toggle-btn ${appState.currentView === 'today' ? 'active' : ''}`,
                            onClick: () => {
                                appState.currentView = 'today';
                                renderDashboard();
                            }
                        }, ['Today']),
                        createElement('button', {
                            className: `toggle-btn ${appState.currentView === 'week' ? 'active' : ''}`,
                            onClick: () => {
                                appState.currentView = 'week';
                                renderDashboard();
                            }
                        }, ['Week'])
                    ]),
                    createElement('button', {
                        className: 'btn btn-primary',
                        onClick: showAdminPinModal
                    }, ['Admin'])
                ])
            ]);

            // Tasks section
            const tasksSection = createElement('div', { className: 'tasks-container' }, [
                createElement('h3', { style: { marginBottom: '20px', color: 'var(--text)' } }, 
                    [`${appState.currentView === 'today' ? 'Today\'s' : 'This Week\'s'} Tasks`]),
                createElement('div', { className: 'tasks-list' },
                    getFilteredTasks().map(taskInstance => {
                        const person = appState.people.find(p => p.id === taskInstance.assignedTo);
                        return createElement('div', {
                            className: `task-item ${taskInstance.isCompleted ? 'completed' : ''} ${taskInstance.isOverdue ? 'overdue' : ''}`
                        }, [
                            createElement('div', { className: 'task-header' }, [
                                createElement('div', { className: 'task-title' }, [taskInstance.task.title]),
                                createElement('div', { className: 'task-actions' }, [
                                    createElement('span', { className: 'task-time' }, [`${taskInstance.task.estimatedMinutes} min`]),
                                    !taskInstance.isCompleted && createElement('button', {
                                        className: 'btn btn-success',
                                        onClick: async () => {
                                            await completeTask(taskInstance.id);
                                            renderDashboard();
                                        }
                                    }, ['Complete'])
                                ])
                            ]),
                            createElement('div', { className: 'task-description' }, [taskInstance.task.description]),
                            createElement('div', { className: 'task-assignee' }, [
                                createElement('div', {
                                    className: 'assignee-avatar',
                                    style: { background: person?.avatar || '#666' }
                                }, [person?.nickname?.charAt(0) || '?']),
                                createElement('span', {}, [person?.nickname || 'Unknown'])
                            ])
                        ]);
                    })
                )
            ]);

            const dashboard = createElement('div', { className: 'dashboard' }, [
                membersSection,
                controlsSection,
                tasksSection
            ]);

            container.appendChild(dashboard);
        }

        function renderAdminPanel() {
            const container = document.getElementById('app');
            container.innerHTML = '';

            const adminPanel = createElement('div', { className: 'admin-controls' }, [
                createElement('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' } }, [
                    createElement('h2', {}, ['Admin Panel']),
                    createElement('button', {
                        className: 'btn btn-secondary',
                        onClick: () => renderDashboard()
                    }, ['Back to Dashboard'])
                ]),
                createElement('div', { className: 'admin-nav' }, [
                    createElement('button', {
                        className: `nav-btn ${appState.adminView === 'people' ? 'active' : ''}`,
                        onClick: () => {
                            appState.adminView = 'people';
                            renderAdminPanel();
                        }
                    }, ['Family Members']),
                    createElement('button', {
                        className: `nav-btn ${appState.adminView === 'tasks' ? 'active' : ''}`,
                        onClick: () => {
                            appState.adminView = 'tasks';
                            renderAdminPanel();
                        }
                    }, ['Tasks'])
                ]),
                createElement('div', { className: 'admin-content' }, [
                    appState.adminView === 'people' ? renderPeopleAdmin() : renderTasksAdmin()
                ])
            ]);

            container.appendChild(adminPanel);
        }

        function renderPeopleAdmin() {
            return createElement('div', {}, [
                createElement('div', { className: 'people-grid' },
                    appState.people.map(person => 
                        createElement('div', { className: 'person-card' }, [
                            createElement('div', {
                                className: 'person-avatar-large',
                                style: { background: person.avatar }
                            }, [person.nickname.charAt(0)]),
                            createElement('div', { className: 'person-name' }, [person.nickname]),
                            createElement('div', { style: { color: 'var(--text-light)', marginBottom: '15px' } }, 
                                [`${person.totalPoints} points • ${person.currentStreak} day streak`]),
                            createElement('button', {
                                className: 'btn btn-primary',
                                style: { width: '100%' },
                                onClick: () => showEditPersonModal(person)
                            }, ['Edit'])
                        ])
                    )
                )
            ]);
        }

        function renderTasksAdmin() {
            return createElement('div', {}, [
                createElement('div', { style: { display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px' } }, [
                    createElement('h3', {}, ['Manage Tasks']),
                    createElement('button', {
                        className: 'btn btn-primary',
                        onClick: () => showEditTaskModal()
                    }, ['Add Task'])
                ]),
                createElement('div', { className: 'tasks-list' },
                    appState.tasks.map(taskInstance => {
                        const person = appState.people.find(p => p.id === taskInstance.assignedTo);
                        return createElement('div', { className: 'task-item' }, [
                            createElement('div', { className: 'task-header' }, [
                                createElement('div', { className: 'task-title' }, [taskInstance.task.title]),
                                createElement('div', { className: 'task-actions' }, [
                                    createElement('span', { className: 'task-time' }, [`${taskInstance.task.estimatedMinutes} min`]),
                                    createElement('button', {
                                        className: 'btn-icon',
                                        onClick: () => showEditTaskModal(taskInstance.task),
                                        title: 'Edit task'
                                    }, ['⚙️'])
                                ])
                            ]),
                            createElement('div', { className: 'task-description' }, [taskInstance.task.description]),
                            createElement('div', { className: 'task-assignee' }, [
                                createElement('div', {
                                    className: 'assignee-avatar',
                                    style: { background: person?.avatar || '#666' }
                                }, [person?.nickname?.charAt(0) || '?']),
                                createElement('span', {}, [person?.nickname || 'Unassigned'])
                            ])
                        ]);
                    })
                )
            ]);
        }

        function getFilteredTasks() {
            if (appState.currentView === 'today') {
                return appState.tasks.filter(t => 
                    (appState.selectedPerson === null || t.assignedTo === appState.selectedPerson) &&
                    t.dueDate === new Date().toISOString().split('T')[0]
                );
            } else {
                return appState.tasks.filter(t => 
                    appState.selectedPerson === null || t.assignedTo === appState.selectedPerson
                );
            }
        }

        // Initialize the app
        async function initApp() {
            // Check if user is already logged in (for demo purposes, auto-login)
            appState.isAuthenticated = true;
            appState.user = { email: 'family@example.com' };
            
            if (appState.isAuthenticated) {
                await loadDashboard();
                renderDashboard();
            } else {
                renderLogin();
            }
        }

        // Start the app
        initApp();
    </script>
</body>
</html>